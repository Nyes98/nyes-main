# EVM

- Ethereum Virtual Machine
- 스마트 컨트랙트를 실행하기 위한 가상 컴퓨터
- 블록체인 네트워크 노드(peer)에 포함되어 항상 실행
  - 노드(peer)끼리의 합의에 사용
  - ByteCode 실행에 사용

# Solidity

- 스마트 컨트랙트 프로그래밍 언어
- 컴파일 하여 ByteCode를 생성
- ByteCode는 트랜잭션의 data로 젖아되어 스마트 컨트랙르 실행 시 사용

# geth 새롭게 개인 네트워크 생성

```json
{
  "difficulty": "200000",
  "gasLimit": "3100000",
  "alloc": {},
  "config": {
    "chainId": 745624562456,
    "homesteadBlock": 0,
    "eip150Block": 0,
    "eip155Block": 0,
    "eip158Block": 0,
    "byzantiumBlock": 0,
    "constantinopleBlock": 0
  }
}
```

- 추가된 2 옵션은 스마트 컨트랙트를 실행하기 위한 옵션
  - 합의 방법이 달라지면서 필요하게 되었다.

```sh
geth --datadir newGeth init newGenesis.json
```

# geth 실행

```sh
geth --datadir ~/newGeth --http --http.port 8888 --http.corsdomain "*" --http.api "admin,miner,txpool,web3,personal,eth,net" --allow-insecure-unlock --syncmode full --networkid 745624562456 --ws --ws.port 7777 --ws.origins "*" --nodiscover
```

- nodiscover : 남이 내 노드(peer)를 못찾게 한다.
  - === maxpeers 0

# 계정 생성

```sh
geth --datadir ~/newGeth account new
```

# Geth 실행 시 unlock

```sh
echo 12341234 >> ~/newGeth/password
```

- echo :퍄 cmd,bash,powershell에서 사용하는 console.log
- ">>" : 해당 파일에 출력 값을 저장

```sh
geth --datadir ~/newGeth --http --http.port 8888 --http.corsdomain "*" --http.api "admin,miner,txpool,web3,personal,eth,net" --allow-insecure-unlock --syncmode full --networkid 745624562456 --ws --ws.port 7777 --ws.origins "*" --nodiscover --unlock "0" --password ./newGeth/password
```

- unlock : accounts에서의 인덱스
- password : 비밀번호가 저장된 파일
  - 줄바꿈으로 입력된 unlock 인덱스들과 맞춰야한다.

# Solidity 프리티어 설정

```sh
npm i -D prettier-plugin-solidity
```

```json
{
  "prettier.documentSelectors": ["**/*.sol"]
}
```

- setting.json에 해당 내용을 추가

```solidity
// SPDX-License-Identifier: MIT
// 라이선스 표기 << 어떤 라이선스를 사용하는가?

pragma solidity ^0.8.15;

// 솔리디티 버전 설정

contract Test {
  // contract : javascript에서의 class와 같다.
  string text;

  constructor() {
    text = "Hi Block7";
  }

  function getText() public view returns (string memory) {
    // public : 외부에서 사용가능한 데이터
    // view : 읽기 전용 데이터 처리 / pure(없어도 됨)
    // returns : 반환하는 데이터
    // memory : 함수 내에서만 변수 사용, 데이터를 외부에 저장하지 않음(지역변수 처리, 없어도 됨)
    return text;
  }

  function setText(string memory _value) public {
    text = _value;
  }
}
```

# 컴파일

```sh
npm i solc
npx solc --bin --abi ./test.sol
```

- solc : Solidity Compiler
- --bin : binary, transaction에 저장되는 실제 ByteCode
  - Solidity 등 우리가 작성한 코드를 EVM에서 실행할 수 있는 ByteCode로 변환(컴파일 한다.)
  - 해당 ByteCode는 트랜잭션에 저장
  - 헤당 코드를 Receipt 내의 ContractAddress로 찾음
- --abi : Application Binary Interface, 스마트 컨트랙트 내의 함수와 매개변수 등을 json 형식으로 표기
  - abi는 데이터의 정확한 매칭(인코딩)을 위해서 사용
  - 데이터(변수, 함수, 메서드, 프로퍼티)가 이쓴ㄴ지 미리 정해두고 맞춘다.

# 스마트 컨트랙트를 트랜잭션으로 보내기

1. 편의를 위해 변수 선언

```js
data =
  "0x60806040523480156200001157600080fd5b506040518060400160405280600981526020017f486920426c6f636b37000000000000000000000000000000000000000000000081525060009081620000589190620002d9565b50620003c0565b600081519050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b60006002820490506001821680620000e157607f821691505b602082108103620000f757620000f662000099565b5b50919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b600060088302620001617fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8262000122565b6200016d868362000122565b95508019841693508086168417925050509392505050565b6000819050919050565b6000819050919050565b6000620001ba620001b4620001ae8462000185565b6200018f565b62000185565b9050919050565b6000819050919050565b620001d68362000199565b620001ee620001e582620001c1565b8484546200012f565b825550505050565b600090565b62000205620001f6565b62000212818484620001cb565b505050565b5b818110156200023a576200022e600082620001fb565b60018101905062000218565b5050565b601f82111562000289576200025381620000fd565b6200025e8462000112565b810160208510156200026e578190505b620002866200027d8562000112565b83018262000217565b50505b505050565b600082821c905092915050565b6000620002ae600019846008026200028e565b1980831691505092915050565b6000620002c983836200029b565b9150826002028217905092915050565b620002e4826200005f565b67ffffffffffffffff8111156200030057620002ff6200006a565b5b6200030c8254620000c8565b620003198282856200023e565b600060209050601f8311600181146200035157600084156200033c578287015190505b620003488582620002bb565b865550620003b8565b601f1984166200036186620000fd565b60005b828110156200038b5784890151825560018201915060208501945060208101905062000364565b86831015620003ab5784890151620003a7601f8916826200029b565b8355505b6001600288020188555050505b505050505050565b61067c80620003d06000396000f3fe608060405234801561001057600080fd5b50600436106100365760003560e01c80635d3a1f9d1461003b578063e00fe2eb14610057575b600080fd5b61005560048036038101906100509190610274565b610075565b005b61005f610088565b60405161006c919061033c565b60405180910390f35b80600090816100849190610574565b5050565b6060600080546100979061038d565b80601f01602080910402602001604051908101604052809291908181526020018280546100c39061038d565b80156101105780601f106100e557610100808354040283529160200191610110565b820191906000526020600020905b8154815290600101906020018083116100f357829003601f168201915b5050505050905090565b6000604051905090565b600080fd5b600080fd5b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b61018182610138565b810181811067ffffffffffffffff821117156101a05761019f610149565b5b80604052505050565b60006101b361011a565b90506101bf8282610178565b919050565b600067ffffffffffffffff8211156101df576101de610149565b5b6101e882610138565b9050602081019050919050565b82818337600083830152505050565b6000610217610212846101c4565b6101a9565b90508281526020810184848401111561023357610232610133565b5b61023e8482856101f5565b509392505050565b600082601f83011261025b5761025a61012e565b5b813561026b848260208601610204565b91505092915050565b60006020828403121561028a57610289610124565b5b600082013567ffffffffffffffff8111156102a8576102a7610129565b5b6102b484828501610246565b91505092915050565b600081519050919050565b600082825260208201905092915050565b60005b838110156102f75780820151818401526020810190506102dc565b60008484015250505050565b600061030e826102bd565b61031881856102c8565b93506103288185602086016102d9565b61033181610138565b840191505092915050565b600060208201905081810360008301526103568184610303565b905092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b600060028204905060018216806103a557607f821691505b6020821081036103b8576103b761035e565b5b50919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b6000600883026104207fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff826103e3565b61042a86836103e3565b95508019841693508086168417925050509392505050565b6000819050919050565b6000819050919050565b600061047161046c61046784610442565b61044c565b610442565b9050919050565b6000819050919050565b61048b83610456565b61049f61049782610478565b8484546103f0565b825550505050565b600090565b6104b46104a7565b6104bf818484610482565b505050565b5b818110156104e3576104d86000826104ac565b6001810190506104c5565b5050565b601f821115610528576104f9816103be565b610502846103d3565b81016020851015610511578190505b61052561051d856103d3565b8301826104c4565b50505b505050565b600082821c905092915050565b600061054b6000198460080261052d565b1980831691505092915050565b6000610564838361053a565b9150826002028217905092915050565b61057d826102bd565b67ffffffffffffffff81111561059657610595610149565b5b6105a0825461038d565b6105ab8282856104e7565b600060209050601f8311600181146105de57600084156105cc578287015190505b6105d68582610558565b86555061063e565b601f1984166105ec866103be565b60005b82811015610614578489015182556001820191506020850194506020810190506105ef565b86831015610631578489015161062d601f89168261053a565b8355505b6001600288020188555050505b50505050505056fea2646970667358221220c4e34717fe4e1e7bfa8c892b8a587dd3b04a38dbce46bf0835510779b0b97a6464736f6c63430008130033";
//   solc로 생성된 bin 파일 내의 모든 데이터
txObj = { from: eth.accounts[0], data, gas: 1000000 };
```

2. 트랜잭션 보내기

```sh
eth.sendTransaction(txObj)
# "0x12fb3032b09ebce4413d9c4a497d9d81b839b07cd5895b28d8ffd94a20a1f023"
miner.start()
miner.stop()
```

3. 트랜잭션 확인하기

```sh
eth.getTransaction("0x12fb3032b09ebce4413d9c4a497d9d81b839b07cd5895b28d8ffd94a20a1f023")eth.eth.getTransactionReceipt("0x12fb3032b09ebce4413d9c4a497d9d81b839b07cd5895b28d8ffd94a20a1f023")
```

- getTransactionReceipt의 결과

```js
{
  blockHash: "0x9f75754421b6b0e437c574d8bc3664ac77dd6c228faf25f436269ea339cfaa09",
  blockNumber: 99,
  contractAddress: "0x2bdd47572fd94ff1c5c9f37bd7ad18992053432f",
  cumulativeGasUsed: 565399,
  effectiveGasPrice: 1000000000,
  from: "0x1948cc92389c53c8d7a353d57bdbb0f99db4b5a5",
  gasUsed: 565399,
  logs: [],
  logsBloom: "0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
  status: "0x1",
  to: null,
  transactionHash: "0x12fb3032b09ebce4413d9c4a497d9d81b839b07cd5895b28d8ffd94a20a1f023",
  transactionIndex: 0,
  type: "0x0"
}
```

- contractAddress : CA
  - CA : 스마트 컨트랙트에 대한 주소
  - EOA : Externally Owned Account, 지갑 주소, 메타마스크/Geth 내의 지갑등을 뜻한다.
  - CA/EOA 둘 다 계정으로 분류된다.

4. 컨트랙트 생성(연결)

```sh
contract=eth.contract([{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[],"name":"getText","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"_value","type":"string"}],"name":"setText","outputs":[],"stateMutability":"nonpayable","type":"function"}])
```

- 매개변수로 abi로 추출된 데이터를 입력

5. 컨트랙트에 CA 연결

```sh
 instance=contract.at("0x2bdd47572fd94ff1c5c9f37bd7ad18992053432f"),
```

- at 메서드를 호출하며 ContractAddress를 매개변수로 전달
- 앞으로 스마트 컨트랙트 실행 시 instance 변수를 사용

6. 컨트랙트 실행하여 확인

```sh
instance.getText.call()
```

- Solidity에서 작성해둔 getText 메서드를 호출한다.

7. set 메서드 호출

```sh
instance.setText("why so serious", {from:eth.accounts[0]})
```

- 첫 매개변수로 값을 보내고 두번째 매개변수로 트랜잭션의 내용을 전달
- 데이터가 바뀌었기 때문에 채굴을 통해서 불록을 생성하여 적용한다.
- 호출 시에 가스가 들기 때문에 잔액이 있는 계정으로 호출해야한다.

# EVM은 무료일까?

- 유료이기 때문에 Gas가 필요하다.
- EVM이 유료인 이유 : 잦은 변경을 막기 위해서, 남의 컴퓨터를 사용하는데 무료로 사용 할 순 없다.
- 이더리움 블록체인 네트워크에 노드(peer)가 하나일 경우
  - 해킹이 쉬워진다.

# ganache 사용

```sh
npm i -g ganache
```

# 크립토좀비
